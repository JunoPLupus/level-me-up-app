<div class="screen-container">

  <header class="app-header">

    <div class="header-top">

      <div class="user-area">
        <div class="avatar-circle">
          <img
            [src]="currentUser()?.photoGoogleUrl || '/assets/avatar-placeholder.jpg'"
            alt="Avatar"
            class="avatar-img"
            referrerpolicy="no-referrer"
          >
          <span class="level-badge">LV {{ currentUser()?.levelInfo?.currentLevel || '0' }}</span>
        </div>

        <div class="user-info">
          <h1 class="greeting">Olá, {{ currentUser()?.displayName || 'Visitante' }}!</h1>

          <button class="tag-dropdown-trigger" [matMenuTriggerFor]="tagsMenu">
            <mat-icon class="tag-icon">local_offer</mat-icon>
            <span class="selected-tag-label">
              {{ selectedTagId() === 'ALL' ? 'Todos' : getTagName(selectedTagId()) }}
            </span>
            <mat-icon class="chevron-icon">expand_more</mat-icon>
          </button>
        </div>
      </div>

      <div class="date-area" (click)="picker.open()">
        <mat-icon>calendar_today</mat-icon>
        <span class="date-label">{{ selectedDate() | relativeDate:false }}</span>

        <input matInput
               [matDatepicker]="picker"
               class="hidden-input"
               (dateChange)="changeDateFilter($event)"
        >
        <mat-datepicker #picker></mat-datepicker>
      </div>

    </div>

    <nav class="status-tabs">
      <button
        class="tab-btn"
        [class.active]="selectedStatus() === TaskStatus.PENDING"
        (click)="changeStatusFilter(TaskStatus.PENDING)">
        Pendentes ({{ tasksCount().pendentes }})
      </button>

      <button
        class="tab-btn"
        [class.active]="selectedStatus() === TaskStatus.COMPLETED"
        (click)="changeStatusFilter(TaskStatus.COMPLETED)">
        Concluídas ({{ tasksCount().concluidas }})
      </button>

      <button class="tab-btn disabled">
        Perdidas ({{ tasksCount().perdidas }})
      </button>
    </nav>

  </header>

  <mat-menu #tagsMenu="matMenu" class="custom-menu">
    <button mat-menu-item (click)="changeTagFilter('ALL')">Todos</button>
    @for (tag of availableTags(); track tag.id) {
      <button mat-menu-item (click)="changeTagFilter(tag.id)">
        {{ tag.name }}
      </button>
    }
  </mat-menu>

  <main class="task-list-content">

    @if (groupedTasks().length === 0) {
      <div class="empty-state">
        <p>Nenhuma tarefa encontrada.</p>
      </div>
    }

    @for (group of groupedTasks(); track group.tagName) {
      <section class="task-group">
        <h2 class="group-title">{{ group.tagName }}</h2>
        <div class="group-items">
          @for (task of group.tasks; track task.id) {
            <app-task-list-item
              [task]="task"
              [isCompleted]="isTaskCompleted(task.id)"
              (statusToggle)="onToggleTask(task, $event)">
            </app-task-list-item>
          }
        </div>
      </section>
    }
  </main>

  <app-add-task-button></app-add-task-button>

</div>
